#include <gtest/gtest.h>

#include "Diffuser/SchroederDiffuser.h"
#include "Helpers/CreateExpectedSet.h"
namespace AbacDsp::Test
{

class SchroederDiffuserTest : public ::testing::Test
{
  protected:
    void SetUp() override
    {
        m_sut.setBottomSize(1);
        m_sut.setTopSize(10);
    }

    SchroederDiffuser<1000, 4, 16> m_sut{48000.f};
};

TEST_F(SchroederDiffuserTest, checkStandardDecay)
{
    m_sut.setBottomSize(11);
    m_sut.setTopSize(29);
    m_sut.setFeedback(0.65f);
    std::array<float, 16> in{0};
    std::array<float, 16> out{};
    for (size_t j = 0; j < 100; ++j)
    {
        m_sut.processBlock(in.data(), out.data());
    }
    // clang-format off
    const std::vector<float> expected{
        1.78506E-01f, 0.f, 0.f, 0.f, 0.f, 0.f, 0.f, 0.f, 0.f, 0.f,
        0.f, -1.58596E-01f, 0.f, -1.58596E-01f, 0.f, 0.f, 0.f, -1.58596E-01f, 0.f, -1.58596E-01f,
        0.f, 0.f, -1.03087E-01f, 0.f, 1.40906E-01f, 0.f, -1.03087E-01f, 0.f, 1.40906E-01f, 0.f,
        2.81813E-01f, 0.f, 1.40906E-01f, -6.70068E-02f, -1.03087E-01f, 9.15892E-02f, 1.40906E-01f, 9.15892E-02f, -1.03087E-01f, 2.45824E-02f,
        0.f, -3.36008E-02f, 0.f, -3.36008E-02f, -4.35544E-02f, 1.83178E-01f, 5.95329E-02f, -3.36008E-02f, 5.95329E-02f, -3.36008E-02f,
        1.19066E-01f, 2.45824E-02f, -6.53949E-02f, 9.15891E-02f, -1.62747E-01f, 6.32788E-02f, 3.76924E-02f, -2.83104E-02f, -1.03214E-01f, 3.86964E-02f,
        2.30292E-01f, 7.73928E-02f, -1.03214E-01f, 2.45001E-02f, 3.76924E-02f, -1.34096E-01f, -1.81149E-01f, -6.70891E-02f, -4.02422E-02f, -1.19982E-01f,
        1.44219E-01f, 9.67973E-02f, 1.09838E-01f, 9.67973E-02f, 7.54580E-02f, -2.11571E-01f, -8.71623E-02f, 8.48362E-02f, -6.20096E-02f, 1.13147E-01f,
        -1.37521E-01f, -1.03633E-01f, 2.85379E-02f, -3.43906E-02f, 2.85379E-02f, -1.23745E-01f, -3.09950E-02f, -3.84504E-03f, -9.83027E-02f, 6.53969E-02f,
        2.05224E-01f, -6.26534E-02f, -7.99009E-02f, 1.85497E-02f, -9.74100E-03f, -3.21079E-02f, 3.52663E-02f, -4.24939E-02f, 1.01136E-02f, 5.34524E-03f,
        -1.45318E-01f, 3.36556E-02f, -1.09485E-01f, 3.36556E-02f, -6.44780E-02f, -1.44825E-02f, -1.16960E-02f, 3.11215E-02f, 8.15862E-03f, 1.47722E-02f,
        1.41014E-02f, 5.33055E-03f, 9.20361E-02f, -7.33531E-02f, -6.13566E-02f, -5.40196E-03f, 4.62207E-02f, -4.31540E-02f, 1.49309E-02f, -1.45094E-01f,
        1.49309E-02f, -2.86209E-02f, 8.79380E-03f, 5.68741E-03f, 1.71824E-02f, 1.16854E-02f, -4.84877E-02f, 2.06017E-02f, 5.52135E-02f, 6.22166E-02f,
        -3.94853E-02f, 2.26106E-02f, -6.35800E-02f, -2.78135E-03f, -1.16370E-02f, 1.46324E-02f, -2.61401E-02f, 1.06432E-02f, -3.63230E-02f, 6.65413E-03f,
        -5.37464E-03f, 2.84559E-02f, 9.15103E-03f, -3.40004E-02f, 1.04568E-02f, 1.89771E-03f, 3.30165E-02f, 2.36995E-02f, 1.97966E-02f, -1.12297E-02f,
        4.23563E-02f, -2.98097E-02f, -8.28090E-03f, -2.28875E-02f, 1.30786E-02f, 1.60976E-02f, 5.99582E-03f, -2.46685E-02f, 2.15548E-02f, 2.35543E-03f,
        7.47811E-04f, 1.01117E-02f, 1.38235E-02f, 2.18571E-02f, 9.44993E-04f, 9.96458E-03f, 1.40207E-02f, 3.36711E-02f, -6.09042E-03f, 2.40137E-02f,
        -2.78391E-02f, -5.69906E-04f, 8.12816E-03f, 1.42159E-02f, 1.12728E-02f, 2.21941E-02f, -1.09831E-02f, 7.43651E-03f, 6.07337E-03f, 1.47027E-02f,
        1.81978E-02f, 9.77104E-03f, 7.76918E-03f, 6.87946E-04f, 2.08186E-02f, 1.08725E-02f, 2.23160E-02f, -8.64732E-03f, 2.33506E-02f, -1.94876E-03f,
        5.18190E-03f, 7.00278E-03f, 1.84811E-02f, 1.21853E-02f, 1.07856E-02f, -4.03496E-03f, 1.47072E-02f, 1.11346E-02f, 1.05955E-02f, 9.40958E-03f,
        7.17481E-03f, 1.64686E-02f, 2.36630E-03f, 1.71411E-02f, 5.04305E-03f, 1.78136E-02f, 5.55943E-03f, 1.91981E-02f, -6.36912E-04f, 9.71793E-03f,
        7.46938E-03f, 1.01506E-02f, 1.04994E-02f, 1.39326E-02f, 4.79941E-03f, 1.09001E-02f, 7.82944E-03f, 7.86756E-03f, 1.24178E-02f, 5.97507E-03f,
        1.32736E-02f, -9.46862E-05f, 1.36198E-02f, 1.00079E-02f, 1.45197E-02f, 5.28994E-03f, 1.70385E-02f, 3.27035E-03f, 5.39562E-03f, 7.93820E-03f,
        1.11388E-02f, 1.08919E-02f, 9.96909E-03f, 3.71742E-03f, 7.26852E-03f, 9.39820E-03f, 6.20352E-03f, 1.00225E-02f, 3.64601E-03f, 1.04266E-02f,
        5.47503E-03f, 1.07915E-02f, 8.49045E-03f, 1.24287E-02f, 5.38539E-03f, 1.03424E-02f, 4.26821E-03f, 6.54484E-03f, 7.98626E-03f, 7.98773E-03f,
        7.59055E-03f, 7.13445E-03f, 5.23479E-03f, 6.17603E-03f, 7.39448E-03f, 4.48869E-03f, 7.59674E-03f, 5.67755E-03f, 8.19806E-03f, 4.96799E-03f,
        9.01450E-03f, 6.86376E-03f, 7.70261E-03f, 4.90455E-03f, 9.03708E-03f, 4.62295E-03f, 5.24184E-03f, 5.46649E-03f, 6.01460E-03f, 6.87029E-03f,
        5.41032E-03f, 4.34271E-03f, 4.36273E-03f, 5.54619E-03f, 5.07505E-03f, 5.92137E-03f, 4.61383E-03f, 6.86194E-03f, 4.06662E-03f, 5.94118E-03f,
        5.44194E-03f, 6.78143E-03f, 4.45742E-03f, 6.38864E-03f, 3.25181E-03f, 3.94670E-03f, 4.83221E-03f, 4.41672E-03f, 5.12364E-03f, 3.71919E-03f,
        3.45518E-03f, 4.28220E-03f, 4.46419E-03f, 3.94312E-03f, 5.01036E-03f, 3.58744E-03f, 4.41187E-03f, 3.32258E-03f, 5.01848E-03f, 4.38075E-03f,
        4.72684E-03f, 3.08829E-03f, 4.53197E-03f, 3.04867E-03f, 2.92373E-03f, 3.70453E-03f, 3.03116E-03f, 3.83647E-03f, 3.38492E-03f, 2.73833E-03f,
        3.23285E-03f, 3.64658E-03f, 2.95744E-03f, 3.24392E-03f, 2.79651E-03f, 3.63822E-03f, 2.77076E-03f, 3.48794E-03f, 3.05207E-03f, 3.33675E-03f,
        2.67691E-03f, 3.19862E-03f, 2.29718E-03f, 2.02451E-03f, 2.74903E-03f, 2.60901E-03f, 2.82593E-03f, 2.50440E-03f, 2.27618E-03f, 2.39342E-03f,
        2.37346E-03f, 2.27667E-03f, 2.62230E-03f, 2.24995E-03f, 2.52462E-03f, 1.91310E-03f, 2.45330E-03f, 2.42691E-03f, 2.33775E-03f, 1.95297E-03f,
        2.16427E-03f, 1.72236E-03f, 1.75432E-03f, 2.01122E-03f, 1.92425E-03f, 2.16783E-03f, 1.84836E-03f, 1.49091E-03f, 1.77248E-03f, 1.88476E-03f,
        1.76590E-03f, 1.80913E-03f, 1.54021E-03f, 1.76493E-03f, 1.53697E-03f, 1.71732E-03f, 1.72139E-03f, 1.59996E-03f, 1.42446E-03f, 1.71166E-03f,
        1.27060E-03f, 1.27995E-03f, 1.52626E-03f, 1.39725E-03f, 1.41700E-03f, 1.34588E-03f, 1.19190E-03f, 1.34160E-03f, 1.30483E-03f, 1.20230E-03f,
        1.27277E-03f, 1.19529E-03f, 1.23990E-03f, 1.09506E-03f, 1.16269E-03f, 1.22217E-03f, 1.24045E-03f, 1.02351E-03f, 1.20565E-03f, 9.70717E-04f,
        9.29742E-04f, 1.00483E-03f, 1.00431E-03f, 1.07646E-03f, 9.99610E-04f, 8.34915E-04f, 9.09066E-04f, 9.07457E-04f, 9.08722E-04f, 8.89051E-04f,
        8.40381E-04f, 8.37779E-04f, 7.80530E-04f, 8.87503E-04f, 8.62808E-04f, 8.67845E-04f, 7.66251E-04f, 8.48282E-04f, 6.44796E-04f, 6.67465E-04f,
        7.51799E-04f, 7.35500E-04f, 7.39896E-04f, 6.74478E-04f, 5.82186E-04f, 6.74642E-04f, 6.30668E-04f, 6.35099E-04f, 5.99268E-04f, 5.95443E-04f,
        6.30629E-04f, 5.55400E-04f, 6.17913E-04f, 6.24992E-04f, 6.07123E-04f, 5.07661E-04f, 5.92852E-04f, 4.83690E-04f, 4.88270E-04f, 5.15243E-04f,
        4.96271E-04f, 5.06883E-04f, 4.95781E-04f, 4.05623E-04f, 4.69780E-04f, 4.24503E-04f, 4.43778E-04f, 4.46140E-04f, 4.18564E-04f, 4.36852E-04f,
        4.03008E-04f, 4.30071E-04f, 4.12667E-04f, 4.22963E-04f, 3.72386E-04f, 4.22662E-04f, 3.32106E-04f, 3.30712E-04f, 3.52210E-04f, 3.59139E-04f,
        3.47582E-04f, 3.42766E-04f, 2.73319E-04f, 3.25602E-04f, 3.13027E-04f, 3.09230E-04f, 3.08418E-04f, 2.99647E-04f, 3.03664E-04f, 2.66412E-04f,
        2.98898E-04f, 2.96075E-04f, 2.98703E-04f, 2.53850E-04f, 2.83476E-04f, 2.27241E-04f, 2.38912E-04f, 2.40915E-04f, 2.46954E-04f, 2.32787E-04f,
        2.36141E-04f, 2.02544E-04f, 2.25325E-04f, 2.16054E-04f, 2.19115E-04f, 2.12947E-04f, 1.97856E-04f, 2.10080E-04f, 1.91355E-04f, 2.09858E-04f,
        2.00242E-04f, 1.99961E-04f, 1.72751E-04f, 1.99944E-04f, 1.55994E-04f, 1.64199E-04f, 1.61429E-04f, 1.69316E-04f, 1.67314E-04f, 1.62513E-04f,
        1.39912E-04f, 1.58288E-04f, 1.48621E-04f, 1.44498E-04f, 1.46745E-04f, 1.40659E-04f, 1.46755E-04f, 1.29760E-04f, 1.40260E-04f, 1.35468E-04f,
        1.40252E-04f, 1.17562E-04f, 1.35831E-04f, 1.04589E-04f, 1.12472E-04f, 1.15380E-04f, 1.15964E-04f, 1.14174E-04f, 1.13464E-04f, 9.63157E-05f,
        1.04458E-04f, 1.02072E-04f, 1.01936E-04f, 1.02067E-04f, 9.48519E-05f, 9.79401E-05f, 8.78280E-05f, 9.78660E-05f, 9.15156E-05f, 9.50014E-05f,
        7.85244E-05f, 9.21275E-05f, 7.48113E-05f, 7.70921E-05f, 7.85531E-05f, 8.05815E-05f, 7.77351E-05f, 7.47241E-05f, 6.61894E-05f, 7.31275E-05f,
        7.06980E-05f, 6.85056E-05f, 6.80243E-05f, 6.39411E-05f, 6.80823E-05f, 5.93597E-05f, 6.62014E-05f, 6.08753E-05f, 6.43202E-05f, 5.54986E-05f,
        6.24427E-05f, 5.09558E-05f, 5.35075E-05f, 5.33587E-05f, 5.30251E-05f, 5.28727E-05f, 5.19842E-05f, 4.58957E-05f, 4.90059E-05f, 4.71072E-05f,
        4.60280E-05f, 4.71387E-05f, 4.30493E-05f, 4.59161E-05f, 3.95019E-05f, 4.47106E-05f, 4.24729E-05f, 4.34811E-05f, 3.75974E-05f, 4.28043E-05f,
        3.46445E-05f, 3.52086E-05f, 3.62473E-05f, 3.66923E-05f, 3.62664E-05f, 3.47566E-05f, 3.05692E-05f, 3.28378E-05f, 3.25255E-05f, 3.08893E-05f,
        3.17262E-05f, 2.85851E-05f, 3.09426E-05f, 2.75827E-05f, 3.01540E-05f, 2.86236E-05f, 2.97096E-05f, 2.54494E-05f, 2.81076E-05f, 2.35271E-05f,
        2.43386E-05f, 2.47986E-05f, 2.44812E-05f, 2.40556E-05f, 2.32356E-05f, 2.11118E-05f, 2.19881E-05f, 2.18514E-05f, 2.04871E-05f, 2.13391E-05f,
        1.98330E-05f, 2.08265E-05f, 1.85835E-05f, 2.05445E-05f, 1.92647E-05f, 1.94982E-05f, 1.71994E-05f, 1.92172E-05f, 1.60998E-05f, 1.62384E-05f,
        1.64353E-05f, 1.63422E-05f, 1.64460E-05f, 1.55300E-05f, 1.41867E-05f, 1.45543E-05f, 1.46722E-05f, 1.41321E-05f, 1.43356E-05f, 1.33187E-05f,
        1.41530E-05f, 1.25095E-05f, 1.34806E-05f, 1.29510E-05f, 1.32965E-05f, 1.17059E-05f, 1.27686E-05f, 1.06721E-05f, 1.08315E-05f, 1.12110E-05f,
        1.09010E-05f, 1.09923E-05f, 1.02660E-05f, 9.52716E-06f, 9.99150E-06f, 9.84256E-06f, 9.46466E-06f, 9.72291E-06f, 8.93794E-06f, 9.28532E-06f,
        8.41111E-06f, 9.16567E-06f, 8.76139E-06f, 8.82381E-06f, 7.74406E-06f, 8.48010E-06f, 7.28082E-06f, 7.22225E-06f, 7.48584E-06f, 7.19779E-06f,
        7.34667E-06f, 7.01885E-06f, 6.39375E-06f, 6.67642E-06f, 6.65980E-06f, 6.33526E-06f, 6.37618E-06f, 5.99189E-06f, 6.29803E-06f, 5.69079E-06f,
        6.07584E-06f, 5.78414E-06f, 5.85326E-06f, 5.25917E-06f, 5.63068E-06f, 4.86325E-06f, 4.76784E-06f, 4.99627E-06f, 4.90389E-06f, 4.90634E-06f,
        4.68071E-06f, 4.32662E-06f, 4.45905E-06f, 4.36576E-06f, 4.23730E-06f, 4.31550E-06f, 4.04132E-06f, 4.17083E-06f, 3.75804E-06f, 4.02615E-06f,
        3.90587E-06f, 3.88201E-06f, 3.50362E-06f, 3.70774E-06f, 3.24612E-06f, 3.24577E-06f, 3.33293E-06f, 3.26513E-06f, 3.30027E-06f, 3.12088E-06f,
        2.83647E-06f, 2.97664E-06f, 2.94907E-06f, 2.84927E-06f, 2.85538E-06f, 2.66536E-06f, 2.76108E-06f, 2.53787E-06f, 2.66743E-06f, 2.59430E-06f,
        2.55477E-06f, 2.33273E-06f, 2.50591E-06f, 2.16558E-06f, 2.16062E-06f, 2.23877E-06f, 2.17314E-06f, 2.16101E-06f, 2.07953E-06f, 1.91613E-06f,
        1.99666E-06f, 1.94968E-06f, 1.87712E-06f, 1.88878E-06f, 1.79441E-06f, 1.82784E-06f, 1.68576E-06f, 1.75456E-06f, 1.72237E-06f, 1.72281E-06f,
        1.55250E-06f, 1.66196E-06f, 1.45470E-06f, 1.43748E-06f, 1.46555E-06f, 1.44571E-06f, 1.45190E-06f, 1.39194E-06f, 1.26702E-06f, 1.31420E-06f,
        1.28878E-06f, 1.26044E-06f, 1.24917E-06f, 1.18991E-06f, 1.20160E-06f, 1.11922E-06f, 1.18094E-06f, 1.14313E-06f, 1.14139E-06f, 1.03983E-06f,
        1.10181E-06f, 9.52433E-07f, 9.55957E-07f, 9.83433E-07f, 9.65910E-07f, 9.57684E-07f, 9.15439E-07f, 8.37555E-07f, 8.80447E-07f, 8.51682E-07f,
        8.34613E-07f, 8.20765E-07f, 7.88771E-07f, 8.07371E-07f, 7.42918E-07f, 7.81646E-07f, 7.63068E-07f, 7.55921E-07f, 6.80329E-07f, 7.30237E-07f,
        6.39131E-07f, 6.38412E-07f, 6.48314E-07f, 6.34797E-07f, 6.31604E-07f, 6.12121E-07f, 5.53509E-07f, 5.82317E-07f, 5.59331E-07f, 5.52512E-07f,
        5.50626E-07f, 5.22708E-07f, 5.33931E-07f, 4.95929E-07f, 5.17190E-07f, 4.98889E-07f, 5.00498E-07f, 4.55256E-07f, 4.85759E-07f, 4.21349E-07f,
        4.19529E-07f, 4.27335E-07f, 4.23756E-07f, 4.16466E-07f, 4.04383E-07f, 3.63520E-07f, 3.85021E-07f, 3.74703E-07f, 3.65644E-07f, 3.63854E-07f,
        3.48237E-07f, 3.53002E-07f, 3.24242E-07f, 3.42147E-07f, 3.32762E-07f, 3.32563E-07f, 2.99767E-07f, 3.18700E-07f, 2.77738E-07f, 2.79938E-07f,
        2.81621E-07f, 2.79673E-07f, 2.73138E-07f, 2.67088E-07f, 2.43540E-07f, 2.54500E-07f, 2.47440E-07f, 2.43183E-07f, 2.40384E-07f, 2.27586E-07f,
        2.33329E-07f, 2.16276E-07f, 2.27104E-07f, 2.18800E-07f, 2.18091E-07f, 1.97361E-07f, 2.11866E-07f, 1.83042E-07f, 1.84713E-07f, 1.84647E-07f
    };
    // clang-format on
    size_t idx = 0;
    in[0] = 1;
    // std::vector<float> result;
    for (size_t j = 0; j < 50; ++j)
    {
        m_sut.processBlock(in.data(), out.data());
        in[0] = 0;
        for (size_t i = 0; i < out.size(); ++i)
        {
            EXPECT_NEAR(out[i], expected[idx++], 1E-6f);
            // result.push_back(out[i]);
        }
    }
    // CreateExpectedSet::printAsTestVector(result, 5, 10);
}

}
